name: Update arXiv dataset daily

on:
  schedule:
    - cron: "10 6 * * *"   # daily 06:10 UTC
  workflow_dispatch:
    inputs:
      DAYS:
        description: "Days to fetch (bootstrap)"
        required: false
        default: "1"

jobs:
  daily:
    runs-on: ubuntu-latest
    env:
      DAYS: ${{ github.event.inputs.DAYS || '1' }}
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: pip install -r requirements.txt --quiet

      - name: Ensure latest Kaggle CLI
        run: python -m pip install --upgrade kaggle --quiet

      - name: Configure Kaggle credentials
        env:
          KAGGLE_USERNAME: ${{ secrets.KAGGLE_USERNAME }}
          KAGGLE_KEY: ${{ secrets.KAGGLE_KEY }}
        run: |
          mkdir -p ~/.kaggle
          printf '{"username":"%s","key":"%s"}' "$KAGGLE_USERNAME" "$KAGGLE_KEY" > ~/.kaggle/kaggle.json
          chmod 600 ~/.kaggle/kaggle.json
          kaggle --version

      - name: Run scraper
        run: DAYS=${{ env.DAYS }} python scripts/arxiv_daily.py

      - name: Optional enrichment
        run: python scripts/enrich_today.py || true

      - name: Prepare Kaggle metadata
        run: cp dataset-metadata.json data/

      - name: List data folder (debug)
        run: ls -lah data

      - name: Validate data files exist
        run: |
          python - <<'PY'
          import os, sys
          files=[f for f in os.listdir('data') if f!='dataset-metadata.json']
          if not files:
              print('ERROR: No data files in data/. Did the scraper write parquet files?')
              sys.exit(1)
          PY

      - name: Create or version Kaggle dataset
        run: |
          # If dataset exists -> version, else create
          set +e
          kaggle datasets status "YOUR_KAGGLE_USERNAME/daily-arxiv-metadata"
          STATUS=$?
          set -e
          if [ $STATUS -eq 0 ]; then
            kaggle datasets version -p data -m "auto daily update" -r zip
          else
            kaggle datasets create -p data -r zip
          fi
